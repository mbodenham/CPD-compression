#
# Command line:
# python compress_detector.py --data-path $DATASET_COCO \
#     --compress maskrcnn.scheduler_agp.non_parallel.yaml
#
#Parameters:
# +----+----------------------------------+------------------+---------------+----------------+------------+------------+----------+----------+----------+------------+---------+----------+------------+
# |    | Name                             | Shape            |   NNZ (dense) |   NNZ (sparse) |   Cols (%) |   Rows (%) |   Ch (%) |   2D (%) |   3D (%) |   Fine (%) |     Std |     Mean |   Abs-Mean |
# |----+----------------------------------+------------------+---------------+----------------+------------+------------+----------+----------+----------+------------+---------+----------+------------|
# |  0 | darknet.conv1.conv1_1.weight     | (32, 3, 3, 3)    |           864 |            864 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.10531 | -0.00020 |    0.06758 |
# |  1 | darknet.conv2.conv2_1.weight     | (64, 32, 3, 3)   |         18432 |          18432 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.03314 | -0.00265 |    0.02001 |
# |  2 | darknet.conv3.conv3_1.weight     | (128, 64, 3, 3)  |         73728 |          73728 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02199 | -0.00130 |    0.01494 |
# |  3 | darknet.conv3.conv3_2.weight     | (64, 128, 1, 1)  |          8192 |           8192 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.03671 | -0.00252 |    0.02577 |
# |  4 | darknet.conv3.conv3_3.weight     | (128, 64, 3, 3)  |         73728 |          73728 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02145 | -0.00182 |    0.01541 |
# |  5 | darknet.conv4_1.conv4_1_1.weight | (256, 128, 3, 3) |        294912 |         294912 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01627 | -0.00051 |    0.01197 |
# |  6 | darknet.conv4_1.conv4_1_2.weight | (128, 256, 1, 1) |         32768 |          32768 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02772 | -0.00229 |    0.01973 |
# |  7 | darknet.conv4_1.conv4_1_3.weight | (256, 128, 3, 3) |        294912 |         294912 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01635 | -0.00162 |    0.01235 |
# |  8 | darknet.conv5_1.conv5_1_1.weight | (512, 256, 3, 3) |       1179648 |        1179648 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01343 | -0.00040 |    0.01039 |
# |  9 | darknet.conv5_1.conv5_1_2.weight | (256, 512, 1, 1) |        131072 |         131072 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01947 | -0.00188 |    0.01443 |
# | 10 | darknet.conv5_1.conv5_1_3.weight | (512, 256, 3, 3) |       1179648 |        1179648 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01274 | -0.00081 |    0.00993 |
# | 11 | rfb3_1.branch0.0.weight          | (32, 128, 1, 1)  |          4096 |           4096 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02338 | -0.00106 |    0.01791 |
# | 12 | rfb3_1.branch1.0.weight          | (32, 128, 1, 1)  |          4096 |           4096 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02193 |  0.00004 |    0.01729 |
# | 13 | rfb3_1.branch1.1.weight          | (32, 32, 1, 3)   |          3072 |           3072 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02489 |  0.00016 |    0.02049 |
# | 14 | rfb3_1.branch1.2.weight          | (32, 32, 3, 1)   |          3072 |           3072 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02690 | -0.00047 |    0.02164 |
# | 15 | rfb3_1.branch1.3.weight          | (32, 32, 3, 3)   |          9216 |           9216 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02039 |  0.00002 |    0.01586 |
# | 16 | rfb3_1.branch2.0.weight          | (32, 128, 1, 1)  |          4096 |           4096 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02285 |  0.00073 |    0.01796 |
# | 17 | rfb3_1.branch2.1.weight          | (32, 32, 1, 5)   |          5120 |           5120 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02551 | -0.00070 |    0.02043 |
# | 18 | rfb3_1.branch2.2.weight          | (32, 32, 5, 1)   |          5120 |           5120 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02539 |  0.00002 |    0.02041 |
# | 19 | rfb3_1.branch2.3.weight          | (32, 32, 3, 3)   |          9216 |           9216 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01991 | -0.00018 |    0.01521 |
# | 20 | rfb3_1.branch3.0.weight          | (32, 128, 1, 1)  |          4096 |           4096 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02197 |  0.00001 |    0.01726 |
# | 21 | rfb3_1.branch3.1.weight          | (32, 32, 1, 7)   |          7168 |           7168 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02147 | -0.00049 |    0.01699 |
# | 22 | rfb3_1.branch3.2.weight          | (32, 32, 7, 1)   |          7168 |           7168 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02035 |  0.00005 |    0.01623 |
# | 23 | rfb3_1.branch3.3.weight          | (32, 32, 3, 3)   |          9216 |           9216 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01790 |  0.00018 |    0.01376 |
# | 24 | rfb3_1.conv_cat.weight           | (32, 128, 3, 3)  |         36864 |          36864 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02154 |  0.00008 |    0.01658 |
# | 25 | rfb3_1.conv_res.weight           | (32, 128, 1, 1)  |          4096 |           4096 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02641 | -0.00117 |    0.02020 |
# | 26 | rfb4_1.branch0.0.weight          | (32, 256, 1, 1)  |          8192 |           8192 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02078 | -0.00015 |    0.01624 |
# | 27 | rfb4_1.branch1.0.weight          | (32, 256, 1, 1)  |          8192 |           8192 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01801 |  0.00024 |    0.01414 |
# | 28 | rfb4_1.branch1.1.weight          | (32, 32, 1, 3)   |          3072 |           3072 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01862 |  0.00062 |    0.01513 |
# | 29 | rfb4_1.branch1.2.weight          | (32, 32, 3, 1)   |          3072 |           3072 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01863 |  0.00023 |    0.01490 |
# | 30 | rfb4_1.branch1.3.weight          | (32, 32, 3, 3)   |          9216 |           9216 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01709 |  0.00001 |    0.01365 |
# | 31 | rfb4_1.branch2.0.weight          | (32, 256, 1, 1)  |          8192 |           8192 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01664 |  0.00003 |    0.01310 |
# | 32 | rfb4_1.branch2.1.weight          | (32, 32, 1, 5)   |          5120 |           5120 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01509 |  0.00020 |    0.01186 |
# | 33 | rfb4_1.branch2.2.weight          | (32, 32, 5, 1)   |          5120 |           5120 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01468 | -0.00023 |    0.01152 |
# | 34 | rfb4_1.branch2.3.weight          | (32, 32, 3, 3)   |          9216 |           9216 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01453 |  0.00006 |    0.01141 |
# | 35 | rfb4_1.branch3.0.weight          | (32, 256, 1, 1)  |          8192 |           8192 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01679 |  0.00025 |    0.01330 |
# | 36 | rfb4_1.branch3.1.weight          | (32, 32, 1, 7)   |          7168 |           7168 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01587 |  0.00003 |    0.01251 |
# | 37 | rfb4_1.branch3.2.weight          | (32, 32, 7, 1)   |          7168 |           7168 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01547 | -0.00035 |    0.01221 |
# | 38 | rfb4_1.branch3.3.weight          | (32, 32, 3, 3)   |          9216 |           9216 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01563 | -0.00003 |    0.01232 |
# | 39 | rfb4_1.conv_cat.weight           | (32, 128, 3, 3)  |         36864 |          36864 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01855 |  0.00037 |    0.01420 |
# | 40 | rfb4_1.conv_res.weight           | (32, 256, 1, 1)  |          8192 |           8192 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02046 | -0.00232 |    0.01603 |
# | 41 | rfb5_1.branch0.0.weight          | (32, 512, 1, 1)  |         16384 |          16384 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01652 | -0.00047 |    0.01292 |
# | 42 | rfb5_1.branch1.0.weight          | (32, 512, 1, 1)  |         16384 |          16384 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01687 | -0.00097 |    0.01340 |
# | 43 | rfb5_1.branch1.1.weight          | (32, 32, 1, 3)   |          3072 |           3072 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01670 |  0.00030 |    0.01329 |
# | 44 | rfb5_1.branch1.2.weight          | (32, 32, 3, 1)   |          3072 |           3072 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01678 |  0.00020 |    0.01309 |
# | 45 | rfb5_1.branch1.3.weight          | (32, 32, 3, 3)   |          9216 |           9216 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01567 | -0.00037 |    0.01242 |
# | 46 | rfb5_1.branch2.0.weight          | (32, 512, 1, 1)  |         16384 |          16384 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01646 |  0.00007 |    0.01271 |
# | 47 | rfb5_1.branch2.1.weight          | (32, 32, 1, 5)   |          5120 |           5120 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01631 |  0.00010 |    0.01301 |
# | 48 | rfb5_1.branch2.2.weight          | (32, 32, 5, 1)   |          5120 |           5120 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01652 |  0.00009 |    0.01328 |
# | 49 | rfb5_1.branch2.3.weight          | (32, 32, 3, 3)   |          9216 |           9216 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01661 |  0.00041 |    0.01295 |
# | 50 | rfb5_1.branch3.0.weight          | (32, 512, 1, 1)  |         16384 |          16384 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01611 |  0.00035 |    0.01248 |
# | 51 | rfb5_1.branch3.1.weight          | (32, 32, 1, 7)   |          7168 |           7168 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01478 |  0.00052 |    0.01159 |
# | 52 | rfb5_1.branch3.2.weight          | (32, 32, 7, 1)   |          7168 |           7168 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01487 |  0.00016 |    0.01172 |
# | 53 | rfb5_1.branch3.3.weight          | (32, 32, 3, 3)   |          9216 |           9216 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01517 |  0.00020 |    0.01202 |
# | 54 | rfb5_1.conv_cat.weight           | (32, 128, 3, 3)  |         36864 |          36864 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01650 |  0.00024 |    0.01300 |
# | 55 | rfb5_1.conv_res.weight           | (32, 512, 1, 1)  |         16384 |          16384 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01583 | -0.00281 |    0.01244 |
# | 56 | agg1.conv_upsample1.weight       | (32, 32, 3, 3)   |          9216 |           9216 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01823 | -0.00032 |    0.01426 |
# | 57 | agg1.conv_upsample2.weight       | (32, 32, 3, 3)   |          9216 |           9216 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02488 |  0.00072 |    0.01929 |
# | 58 | agg1.conv_upsample3.weight       | (32, 32, 3, 3)   |          9216 |           9216 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02705 | -0.00053 |    0.02021 |
# | 59 | agg1.conv_upsample4.weight       | (32, 32, 3, 3)   |          9216 |           9216 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01094 |  0.00019 |    0.00872 |
# | 60 | agg1.conv_upsample5.weight       | (64, 64, 3, 3)   |         36864 |          36864 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01127 | -0.00007 |    0.00903 |
# | 61 | agg1.conv_concat2.weight         | (64, 64, 3, 3)   |         36864 |          36864 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01474 | -0.00007 |    0.01125 |
# | 62 | agg1.conv_concat3.weight         | (96, 96, 3, 3)   |         82944 |          82944 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01797 | -0.00007 |    0.01294 |
# | 63 | agg1.conv4.weight                | (96, 96, 3, 3)   |         82944 |          82944 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01444 | -0.00003 |    0.01098 |
# | 64 | agg1.conv5.weight                | (1, 96, 1, 1)    |            96 |             96 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.01498 | -0.00037 |    0.01347 |
# | 65 | Total sparsity:                  | -                |       3993536 |        3993536 |          0 |          0 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.00000 |  0.00000 |    0.00000 |
# +----+----------------------------------+------------------+---------------+----------------+------------+------------+----------+----------+----------+------------+---------+----------+------------+

version: 1

pruners:
#  darknet_conv1_pruner:
#    class: 'L1RankedStructureParameterPruner'
#    group_type: Filters
#    desired_sparsity: 0.6
#    weights: [darknet.conv1.conv1_1.weight]

  agg1_pruner:
    class: 'L1RankedStructureParameterPruner'
    group_type: Filters
    desired_sparsity: 0.4
    weights: [agg1.conv_upsample1,
              agg1.conv_upsample2,
              agg1.conv_upsample3,
              agg1.conv_upsample4]
                                        
extensions:
  net_thinner:
      class: 'FilterRemover'
      thinning_func_str: remove_filters
      arch: 'vgg19'
      dataset: 'sod'

lr_schedulers:
   exp_finetuning_lr:
     class: ExponentialLR
     gamma: 0.95
     
policies:
#  - pruner:
#      instance_name : darknet_conv1_pruner
#    epochs: [1]

  - pruner:
      instance_name : agg1_pruner
    epochs: [1]
    
  - extension:
      instance_name: net_thinner
    epochs: [1]
    
  - lr_scheduler:
      instance_name: exp_finetuning_lr
    starting_epoch: 10
    ending_epoch: 50
    frequency: 1
    
